<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Attendance Processor</title>
    <style>
        table {
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        h4 {
            margin-top: 30px;
        }
        .late {
            background-color: yellow;
        }
        .early-left { /* Changed from .early-leave to .early-left */
            background-color: yellow; /* Highlight early left in yellow */
        }
        .no-out {
            background-color: #ffcccb; /* Light red */
        }
        .missing-punches {
            background-color: lightblue;
        }
        .leave {
            background-color: red;
            color: white;
        }
        .overtime {
            background-color: lightgreen;
            color: black;
        }
        .sunday {
            background-color: #e6ffe6; /* Light green for Sundays */
        }
        /* Style for radio buttons */
        .shift-options {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .shift-options label {
            margin: 2px 0;
        }
        /* Set a wider width for the Shift column */
        .shift-column {
            width: 150px; /* Increased width for the radio button cell */
        }
    </style>
</head>
<body>
    <h2>Attendance Processor</h2>
    <input type="file" id="excelFile" accept=".xlsx, .xls">
    <br><br>
    <button id="processBtn">Process Attendance</button>
    <button id="downloadBtn" style="display: none;" onclick="downloadExcel()">Download as Excel</button>
    <div id="result"></div>

    <!-- Include SheetJS library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" onerror="console.error('Failed to load SheetJS library');"></script>
    <!-- Include ExcelJS library for formatting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js" onerror="console.error('Failed to load ExcelJS library');"></script>
    
    <script>
        // Log to confirm script is executing
        console.log("Script loaded and executing");

        let globalSummary = null;
        let dateRange = { minDate: null, maxDate: null };
        let rawData = null; // Store raw data for reprocessing
        let employeeShifts = {}; // Store shift selection for each employee (e.g., { "1": "08:00", "2": "09:00" })

        function processFile() {
            try {
                console.log("Process Attendance button clicked");

                // Show warning message before processing
                const proceed = confirm("The data is compiled for reference purpose only, cross-check with the original file to make sure on the accuracy.");
                if (!proceed) {
                    console.log("User cancelled processing");
                    return;
                }

                const fileInput = document.getElementById('excelFile');
                const file = fileInput.files[0];
                if (!file) {
                    alert("Please select a file to process.");
                    console.log("No file selected");
                    return;
                }

                console.log("File selected:", file.name);

                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        console.log("File reader onload triggered");
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array', cellDates: true, raw: false});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];

                        const rawDataArray = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        console.log("Raw Data (first 5 rows):", rawDataArray.slice(0, 5));

                        const headers = rawDataArray[1];
                        const dataRows = rawDataArray.slice(2);

                        rawData = dataRows.map(row => {
                            const rowData = {};
                            headers.forEach((header, index) => {
                                rowData[header] = row[index];
                            });
                            return rowData;
                        });

                        console.log("Column Names:", Object.keys(rawData[0] || {}));
                        console.log("Sample Data (first 5 rows):", rawData.slice(0, 5));

                        // Initialize shifts to default "08:00 AM" for each employee
                        const employeeIds = [...new Set(rawData.map(row => row['Employee ID']))];
                        employeeIds.forEach(empId => {
                            if (empId && empId !== 'Unknown') {
                                employeeShifts[empId] = '08:00'; // Default to 08:00 AM
                            }
                        });

                        const attendanceSummary = processAttendance(rawData);
                        console.log("Final Summary:", attendanceSummary);
                        globalSummary = attendanceSummary;
                        displayResults(attendanceSummary);
                        document.getElementById('downloadBtn').style.display = 'inline';
                    } catch (error) {
                        console.error("Error in file reader onload:", error);
                        alert("An error occurred while processing the file. Check the console for details.");
                    }
                };

                reader.onerror = function(e) {
                    console.error("File reader error:", e);
                    alert("An error occurred while reading the file. Check the console for details.");
                };

                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error("Error in processFile:", error);
                alert("An error occurred while processing the file. Check the console for details.");
            }
        }

        function reprocessAttendance(empId, shift) {
            try {
                console.log(`Reprocessing attendance for Employee ID ${empId} with shift ${shift}`);
                employeeShifts[empId] = shift;
                const attendanceSummary = processAttendance(rawData);
                globalSummary = attendanceSummary;
                displayResults(attendanceSummary);
            } catch (error) {
                console.error("Error in reprocessAttendance:", error);
                alert("An error occurred while reprocessing attendance. Check the console for details.");
            }
        }

        function formatTime(date) {
            if (!date || isNaN(date.getTime())) return 'Missing';
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function getDayOfWeek(dateStr) {
            const date = new Date(dateStr);
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[date.getDay()];
        }

        function getMonthName(monthIndex) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            return months[monthIndex];
        }

        function processAttendance(data) {
            const summary = {};
            const breakfastOutStart = new Date('2025-01-01 09:00:00');
            const breakfastOutEnd = new Date('2025-01-01 10:30:00');
            const breakfastInStart = new Date('2025-01-01 9:15:00');
            const breakfastInEnd = new Date('2025-01-01 11:00:00');
            const lunchOutStart = new Date('2025-01-01 12:30:00');
            const lunchOutEnd = new Date('2025-01-01 14:00:00');
            const lunchInStart = new Date('2025-01-01 13:00:00');
            const lunchInEnd = new Date('2025-01-01 14:30:00');
            const eveningPunchThreshold = new Date('2025-01-01 17:55:00'); // Changed from 17:00 to 17:55 (05:55 PM)
            const duplicateThreshold = 5 * 60 * 1000;

            const groupedData = {};
            const employeeDateRanges = {};

            const chunkSize = 1000;
            for (let i = 0; i < data.length; i += chunkSize) {
                const chunk = data.slice(i, i + chunkSize);
                chunk.forEach((row, index) => {
                    const globalIndex = i + index + 1;
                    const empId = row['Employee ID'] || 'Unknown';
                    const empName = row['First Name'] || 'Unknown';
                    const dateStr = row['Date'];
                    const timeStr = row['Time'];
                    const punchState = row['Punch State'];

                    if (globalIndex <= 100) {
                        console.log(`Row ${globalIndex}:`, { empId, empName, dateStr, timeStr, punchState });
                    }

                    if (!empId || empId === 'Unknown') {
                        console.log(`Skipping Row ${globalIndex}: Missing Employee ID`);
                        return;
                    }
                    if (!dateStr) {
                        console.log(`Skipping Row ${globalIndex}: Missing Date`);
                        return;
                    }
                    if (!timeStr) {
                        console.log(`Skipping Row ${globalIndex}: Missing Time`);
                        return;
                    }
                    if (!punchState) {
                        console.log(`Skipping Row ${globalIndex}: Missing Punch State`);
                        return;
                    }

                    let date;
                    if (typeof dateStr === 'string') {
                        date = new Date(dateStr);
                    } else if (typeof dateStr === 'number') {
                        date = new Date((dateStr - 25569) * 86400 * 1000);
                    } else {
                        console.log(`Skipping Row ${globalIndex}: Invalid date for EMP ID ${empId}: ${dateStr}`);
                        return;
                    }

                    if (isNaN(date.getTime())) {
                        console.log(`Skipping Row ${globalIndex}: Invalid date format for EMP ID ${empId}: ${dateStr}`);
                        return;
                    }

                    // Update global date range
                    if (!dateRange.minDate || date < dateRange.minDate) {
                        dateRange.minDate = new Date(date);
                    }
                    if (!dateRange.maxDate || date > dateRange.maxDate) {
                        dateRange.maxDate = new Date(date);
                    }

                    let punchTime;
                    try {
                        const timeWithSeconds = `${timeStr}:00`;
                        punchTime = new Date(`${date.toISOString().split('T')[0]} ${timeWithSeconds}`);
                        if (isNaN(punchTime.getTime())) {
                            console.log(`Skipping Row ${globalIndex}: Invalid time for EMP ID ${empId}: ${timeStr}`);
                            return;
                        }
                    } catch (e) {
                        console.log(`Skipping Row ${globalIndex}: Error parsing time for EMP ID ${empId}: ${timeStr}`, e);
                        return;
                    }

                    if (!groupedData[empId]) {
                        groupedData[empId] = {};
                    }
                    const dateKey = date.toISOString().split('T')[0];
                    if (!groupedData[empId][dateKey]) {
                        groupedData[empId][dateKey] = { punches: [], name: empName };
                    }

                    const normalizedPunchState = punchState.trim() === 'Check In' ? 'IN' : punchState.trim() === 'Check Out' ? 'OUT' : punchState;
                    if (globalIndex <= 100) {
                        console.log(`Row ${globalIndex}: Normalized Punch State: ${punchState} -> ${normalizedPunchState}`);
                    }
                    groupedData[empId][dateKey].punches.push({ time: punchTime, state: normalizedPunchState });

                    if (!employeeDateRanges[empId]) {
                        employeeDateRanges[empId] = { minDate: date, maxDate: date, name: empName };
                    } else {
                        if (date < employeeDateRanges[empId].minDate) {
                            employeeDateRanges[empId].minDate = date;
                        }
                        if (date > employeeDateRanges[empId].maxDate) {
                            employeeDateRanges[empId].maxDate = date;
                        }
                    }
                });
            }

            console.log("Grouped Data (sample):", Object.keys(groupedData).slice(0, 5).reduce((acc, empId) => {
                acc[empId] = groupedData[empId];
                return acc;
            }, {}));
            console.log("Employee Date Ranges:", employeeDateRanges);
            console.log("Global Date Range:", { minDate: dateRange.minDate, maxDate: dateRange.maxDate });

            for (const empId in groupedData) {
                if (!summary[empId]) {
                    summary[empId] = {
                        name: groupedData[empId][Object.keys(groupedData[empId])[0]].name,
                        lates: 0,
                        halfDays: 0,
                        halfDaysFromLateArrival: 0,
                        halfDaysFromMissingMorning: 0,
                        halfDaysFromMissingEvening: 0,
                        missingMorningPunches: 0,
                        missingEveningPunches: 0,
                        earlyLeftCount: 0, // Changed from earlyLeaves to earlyLeftCount
                        fullDayLeaves: 0,
                        overtime: 0,
                        totalDeductions: 0,
                        dailyDetails: []
                    };
                }

                // Use global date range to ensure all dates are processed
                const minDate = new Date(dateRange.minDate);
                const maxDate = new Date(dateRange.maxDate);
                for (let d = new Date(minDate); d <= maxDate; d.setDate(d.getDate() + 1)) {
                    const dateKey = d.toISOString().split('T')[0];
                    const date = new Date(dateKey);
                    const isSunday = date.getDay() === 0;

                    // Debug for Rakesh on March 11, 2025
                    if (empId == 6 && dateKey === '2025-03-11') {
                        console.log(`EMP ID ${empId}, Date ${dateKey}: Processing date for Rakesh`);
                    }

                    if (!groupedData[empId][dateKey]) {
                        const dailyDetail = {
                            date: dateKey,
                            day: getDayOfWeek(dateKey),
                            morningPunchIn: isSunday ? 'Holiday' : 'Leave',
                            breakfastOut: isSunday ? 'Holiday' : 'Leave',
                            breakfastIn: isSunday ? 'Holiday' : 'Leave',
                            lunchOut: isSunday ? 'Holiday' : 'Leave',
                            lunchIn: isSunday ? 'Holiday' : 'Leave',
                            eveningPunchOut: isSunday ? 'Holiday' : 'Leave',
                            late: 'No',
                            halfDay: 'No',
                            missingMorningCount: 0, // Do not count missing punches for full-day leave
                            missingEveningCount: 0,
                            missingBreakCount: 0,
                            earlyLeft: 'No', // Changed from earlyLeave to earlyLeft
                            overtime: 'No'
                        };
                        summary[empId].dailyDetails.push(dailyDetail);
                        if (!isSunday) {
                            summary[empId].fullDayLeaves += 1; // Full day leave on working day with no punches
                            // Debug for Rakesh on March 11, 2025
                            if (empId == 6 && dateKey === '2025-03-11') {
                                console.log(`EMP ID ${empId}, Date ${dateKey}: Rakesh - Marked as full day leave (no punches on a working day)`);
                            }
                            // Debug for Ajeesh
                            if (empId == 1) { // Replace 1 with Ajeesh's actual Employee ID
                                console.log(`EMP ID ${empId} (Ajeesh), Date ${dateKey}: Incremented fullDayLeaves to ${summary[empId].fullDayLeaves}`);
                            }
                        }
                        console.log(`EMP ID ${empId}, Date ${dateKey}: Added missing day${isSunday ? ' (Sunday, no deduction)' : ' (Full day leave)'}`);
                        continue; // Skip to next date since there are no punches
                    }

                    // Adjust thresholds based on employee's shift
                    const shiftTime = employeeShifts[empId] || '08:00';
                    const punchInTime = new Date(`2025-01-01 ${shiftTime}:00`);
                    const lateThreshold = new Date(`2025-01-01 ${shiftTime === '08:00' ? '08:05:00' : '09:10:00'}`); // Adjusted for Vysakh
                    const halfDayThreshold = new Date(`2025-01-01 ${shiftTime === '08:00' ? '08:10:00' : '09:10:00'}`);

                    const dateKeyData = groupedData[empId][dateKey];
                    const punches = dateKeyData.punches;
                    const hasPunches = punches.length > 0;

                    punches.sort((a, b) => a.time - b.time);

                    const filteredPunches = [];
                    let lastPunch = null;
                    for (const punch of punches) {
                        if (!lastPunch || (punch.time - lastPunch.time) > duplicateThreshold || punch.state !== lastPunch.state) {
                            filteredPunches.push(punch);
                            lastPunch = punch;
                        } else {
                            console.log(`EMP ID ${empId}, Date ${dateKey}: Ignoring duplicate punch at ${punch.time.toISOString()} with state ${punch.state}`);
                        }
                    }

                    console.log(`EMP ID ${empId}, Date ${dateKey}, All Punches:`, filteredPunches.map(p => `${p.time.toISOString()} ${p.state}`));

                    let morningPunchIn = null, breakfastOut = null, breakfastIn = null, lunchOut = null, lunchIn = null, eveningPunchOut = null;
                    let inCount = 0, outCount = 0;

                    for (const punch of filteredPunches) {
                        if (punch.state === 'IN') inCount++;
                        else if (punch.state === 'OUT') outCount++;
                    }

                    let breakfastOutAssigned = false, breakfastInAssigned = false, lunchOutAssigned = false, lunchInAssigned = false, eveningPunchAssigned = false;

                    for (const punch of filteredPunches) {
                        if (punch.state === 'IN') {
                            if (!morningPunchIn) {
                                morningPunchIn = punch.time;
                                console.log(`EMP ID ${empId}, Date ${dateKey}: Assigned morning punch-in at ${formatTime(punch.time)}`);
                                break;
                            }
                        }
                    }

                    // After the loop, log if morningPunchIn was not assigned
                    if (!morningPunchIn) {
                        console.log(`EMP ID ${empId}, Date ${dateKey}: No morning punch-in found. All punches:`, filteredPunches.map(p => `${p.time.toISOString()} (${p.state})`));
                    }

                    for (const punch of filteredPunches) {
                        if (punch.state === 'OUT') {
                            const punchHours = punch.time.getHours();
                            const punchMinutes = punch.time.getMinutes();
                            const punchTimeInMinutes = punchHours * 60 + punchMinutes;

                            const eveningHours = eveningPunchThreshold.getHours();
                            const eveningMinutes = eveningPunchThreshold.getMinutes();
                            const eveningTimeInMinutes = eveningHours * 60 + eveningMinutes;

                            if (punchTimeInMinutes >= eveningTimeInMinutes && !eveningPunchAssigned) {
                                eveningPunchOut = punch.time;
                                eveningPunchAssigned = true;
                                console.log(`EMP ID ${empId}, Date ${dateKey}: Assigned evening punch-out at ${formatTime(punch.time)}`);
                            }
                        }
                    }

                    if (!eveningPunchAssigned && outCount > 0) {
                        for (let i = filteredPunches.length - 1; i >= 0; i--) {
                            if (filteredPunches[i].state === 'OUT') {
                                eveningPunchOut = filteredPunches[i].time;
                                eveningPunchAssigned = true;
                                console.log(`EMP ID ${empId}, Date ${dateKey}: Assigned evening punch-out (last OUT) at ${formatTime(eveningPunchOut)}`);
                                break;
                            }
                        }
                    }

                    for (const punch of filteredPunches) {
                        const punchHours = punch.time.getHours();
                        const punchMinutes = punch.time.getMinutes();
                        const punchTimeInMinutes = punchHours * 60 + punchMinutes;

                        if (punch.state === 'OUT') {
                            if (eveningPunchOut && punch.time.getTime() === eveningPunchOut.getTime()) {
                                continue;
                            }

                            const breakfastOutStartMinutes = breakfastOutStart.getHours() * 60 + breakfastOutStart.getMinutes();
                            const breakfastOutEndMinutes = breakfastOutEnd.getHours() * 60 + breakfastOutEnd.getMinutes();
                            if (punchTimeInMinutes >= breakfastOutStartMinutes && punchTimeInMinutes <= breakfastOutEndMinutes && !breakfastOutAssigned) {
                                breakfastOut = punch.time;
                                breakfastOutAssigned = true;
                                console.log(`EMP ID ${empId}, Date ${dateKey}: Assigned breakfast out at ${formatTime(punch.time)}`);
                                continue;
                            }

                            const lunchOutStartMinutes = lunchOutStart.getHours() * 60 + lunchOutStart.getMinutes();
                            const lunchOutEndMinutes = lunchOutEnd.getHours() * 60 + lunchOutEnd.getMinutes();
                            if (punchTimeInMinutes >= lunchOutStartMinutes && punchTimeInMinutes <= lunchOutEndMinutes && !lunchOutAssigned) {
                                lunchOut = punch.time;
                                lunchOutAssigned = true;
                                console.log(`EMP ID ${empId}, Date ${dateKey}: Assigned lunch out at ${formatTime(punch.time)}`);
                                continue;
                            }
                        } else if (punch.state === 'IN') {
                            if (morningPunchIn && punch.time.getTime() === morningPunchIn.getTime()) {
                                continue;
                            }

                            const breakfastInStartMinutes = breakfastInStart.getHours() * 60 + breakfastInStart.getMinutes();
                            const breakfastInEndMinutes = breakfastInEnd.getHours() * 60 + breakfastInEnd.getMinutes();
                            if (punchTimeInMinutes >= breakfastInStartMinutes && punchTimeInMinutes <= breakfastInEndMinutes && !breakfastInAssigned) {
                                breakfastIn = punch.time;
                                breakfastInAssigned = true;
                                console.log(`EMP ID ${empId}, Date ${dateKey}: Assigned breakfast in at ${formatTime(punch.time)}`);
                                continue;
                            }

                            const lunchInStartMinutes = lunchInStart.getHours() * 60 + lunchInStart.getMinutes();
                            const lunchInEndMinutes = lunchInEnd.getHours() * 60 + lunchInEnd.getMinutes();
                            if (punchTimeInMinutes >= lunchInStartMinutes && punchTimeInMinutes <= lunchInEndMinutes && !lunchInAssigned) {
                                lunchIn = punch.time;
                                lunchInAssigned = true;
                                console.log(`EMP ID ${empId}, Date ${dateKey}: Assigned lunch in at ${formatTime(punch.time)}`);
                                continue;
                            }
                        }
                    }

                    console.log(`EMP ID ${empId}, Date ${dateKey}:`, {
                        inCount,
                        outCount,
                        morningPunchIn: morningPunchIn ? morningPunchIn.toISOString() : null,
                        breakfastOut: breakfastOut ? breakfastOut.toISOString() : null,
                        breakfastIn: breakfastIn ? breakfastIn.toISOString() : null,
                        lunchOut: lunchOut ? lunchOut.toISOString() : null,
                        lunchIn: lunchIn ? lunchIn.toISOString() : null,
                        eveningPunchOut: eveningPunchOut ? eveningPunchOut.toISOString() : null
                    });

                    let missingMorningCount = 0, missingEveningCount = 0, missingBreakCount = 0, earlyLeft = 'No'; // Changed from earlyLeave to earlyLeft

                    // Check if there are any IN punches on this day
                    let hasInPunch = false;
                    for (const punch of filteredPunches) {
                        if (punch.state === 'IN') {
                            hasInPunch = true;
                            break;
                        }
                    }

                    if (!morningPunchIn || isNaN(morningPunchIn?.getTime())) {
                        if (hasInPunch) {
                            missingMorningCount++;
                            summary[empId].missingMorningPunches++;
                            console.log(`EMP ID ${empId}, Date ${dateKey}: Missing morning punch-in (has other IN punches)`);
                        } else {
                            console.log(`EMP ID ${empId}, Date ${dateKey}: No IN punches on this day, not counting as missing morning punch`);
                        }
                    }
                    if (!eveningPunchOut || isNaN(eveningPunchOut?.getTime())) {
                        missingEveningCount++;
                        summary[empId].missingEveningPunches++;
                        console.log(`EMP ID ${empId}, Date ${dateKey}: Missing evening punch-out`);
                        // Specific case: Rakesh on Feb 22
                        if (empId == 6 && dateKey === '2025-02-22') {
                            console.log(`EMP ID ${empId}, Date ${dateKey}: Rakesh on Feb 22 - Missing Punch Out`);
                        }
                    } else {
                        // Check for early left (changed from early leave)
                        const eveningHours = eveningPunchOut.getHours();
                        const eveningMinutes = eveningPunchOut.getMinutes();
                        const eveningTimeInMinutes = eveningHours * 60 + eveningMinutes;
                        const thresholdHours = eveningPunchThreshold.getHours();
                        const thresholdMinutes = eveningPunchThreshold.getMinutes();
                        const thresholdTimeInMinutes = thresholdHours * 60 + thresholdMinutes;
                        if (eveningTimeInMinutes < thresholdTimeInMinutes) {
                            earlyLeft = `Yes (${formatTime(eveningPunchOut)})`;
                            summary[empId].earlyLeftCount++; // Changed from earlyLeaves to earlyLeftCount
                            console.log(`EMP ID ${empId}, Date ${dateKey}: Early left at ${formatTime(eveningPunchOut)}`);
                        }
                    }

                    if (!breakfastOut || isNaN(breakfastOut?.getTime())) {
                        missingBreakCount++;
                        console.log(`EMP ID ${empId}, Date ${dateKey}: Missing breakfast out`);
                    }
                    if (!breakfastIn || isNaN(breakfastIn?.getTime())) {
                        missingBreakCount++;
                        console.log(`EMP ID ${empId}, Date ${dateKey}: Missing breakfast in`);
                    }
                    if (!lunchOut || isNaN(lunchOut?.getTime())) {
                        missingBreakCount++;
                        console.log(`EMP ID ${empId}, Date ${dateKey}: Missing lunch out`);
                    }
                    if (!lunchIn || isNaN(lunchIn?.getTime())) {
                        missingBreakCount++;
                        console.log(`EMP ID ${empId}, Date ${dateKey}: Missing lunch in`);
                    }

                    const dailyDetail = {
                        date: dateKey,
                        day: getDayOfWeek(dateKey),
                        morningPunchIn: morningPunchIn ? formatTime(morningPunchIn) : (isSunday && !hasPunches ? 'Holiday' : 'Missing'),
                        breakfastOut: breakfastOut ? formatTime(breakfastOut) : (isSunday && !hasPunches ? 'Holiday' : 'Missing'),
                        breakfastIn: breakfastIn ? formatTime(breakfastIn) : (isSunday && !hasPunches ? 'Holiday' : 'Missing'),
                        lunchOut: lunchOut ? formatTime(lunchOut) : (isSunday && !hasPunches ? 'Holiday' : 'Missing'),
                        lunchIn: lunchIn ? formatTime(lunchIn) : (isSunday && !hasPunches ? 'Holiday' : 'Missing'),
                        eveningPunchOut: eveningPunchOut ? formatTime(eveningPunchOut) : (isSunday && !hasPunches ? 'Holiday' : 'Missing'),
                        late: 'No',
                        halfDay: 'No',
                        missingMorningCount: missingMorningCount,
                        missingEveningCount: missingEveningCount,
                        missingBreakCount: (isSunday && !hasPunches) ? 0 : missingBreakCount,
                        earlyLeft: earlyLeft, // Changed from earlyLeave to earlyLeft
                        overtime: 'No'
                    };

                    if (isSunday) {
                        if (hasPunches) {
                            summary[empId].overtime++;
                            dailyDetail.overtime = 'Yes';
                            console.log(`EMP ID ${empId}, Date ${dateKey}: Overtime day detected (Sunday with at least one punch)`);
                        } else {
                            dailyDetail.missingMorningCount = 0;
                            dailyDetail.missingEveningCount = 0;
                            console.log(`EMP ID ${empId}, Date ${dateKey}: Sunday, no punches, not counted as leave`);
                        }
                        summary[empId].dailyDetails.push(dailyDetail);
                        continue;
                    }

                    if (morningPunchIn && !isNaN(morningPunchIn.getTime())) {
                        const morningHours = morningPunchIn.getHours();
                        const morningMinutes = morningPunchIn.getMinutes();
                        const morningSeconds = morningPunchIn.getSeconds();
                        const morningTimeInMinutes = morningHours * 60 + morningMinutes + morningSeconds / 60;

                        const lateHours = lateThreshold.getHours();
                        const lateMinutes = lateThreshold.getMinutes();
                        const lateSeconds = lateThreshold.getSeconds();
                        const lateTimeInMinutes = lateHours * 60 + lateMinutes + lateSeconds / 60;

                        const halfDayHours = halfDayThreshold.getHours();
                        const halfDayMinutes = halfDayThreshold.getMinutes();
                        const halfDaySeconds = halfDayThreshold.getSeconds();
                        const halfDayTimeInMinutes = halfDayHours * 60 + halfDayMinutes + halfDaySeconds / 60;

                        if (morningTimeInMinutes > lateTimeInMinutes) {
                            if (morningTimeInMinutes <= halfDayTimeInMinutes) {
                                summary[empId].lates++;
                                dailyDetail.late = `Yes (${formatTime(morningPunchIn)})`;
                                console.log(`EMP ID ${empId}, Date ${dateKey}: Late arrival at ${morningPunchIn.toISOString()}`);
                                // Specific case: Vysakh on Feb 21
                                if (empId == 10 && dateKey === '2025-02-21' && morningPunchIn.getHours() === 8 && morningPunchIn.getMinutes() === 6) {
                                    console.log(`EMP ID ${empId}, Date ${dateKey}: Vysakh on Feb 21 - Marked as late at 08:06`);
                                }
                            } else {
                                summary[empId].halfDays++;
                                summary[empId].halfDaysFromLateArrival++;
                                dailyDetail.halfDay = `Yes (Late arrival at ${formatTime(morningPunchIn)})`;
                                console.log(`EMP ID ${empId}, Date ${dateKey}: Half day for late arrival at ${morningPunchIn.toISOString()}`);
                            }
                        }
                    }

                    // Calculate deductions from missing punches
                    if (summary[empId].missingMorningPunches > 0) {
                        summary[empId].halfDaysFromMissingMorning += summary[empId].missingMorningPunches;
                        summary[empId].halfDays += summary[empId].missingMorningPunches;
                    }
                    if (summary[empId].missingEveningPunches > 0 && summary[empId].missingEveningPunches % 3 === 0) {
                        const halfDaysFromMissingEvening = Math.floor(summary[empId].missingEveningPunches / 3);
                        summary[empId].halfDaysFromMissingEvening += halfDaysFromMissingEvening;
                        summary[empId].halfDays += halfDaysFromMissingEvening;
                        if (halfDaysFromMissingEvening > 0) {
                            dailyDetail.halfDay = `Yes (${halfDaysFromMissingEvening} half days from ${summary[empId].missingEveningPunches} missing evening punches)`;
                        }
                    }

                    summary[empId].dailyDetails.push(dailyDetail);
                }

                // Calculate total deductions after processing all days
                summary[empId].totalDeductions = (summary[empId].halfDaysFromLateArrival * 0.5) +
                                                 (summary[empId].halfDaysFromMissingMorning * 0.5) +
                                                 (Math.floor(summary[empId].missingEveningPunches / 3) * 0.5) +
                                                 summary[empId].fullDayLeaves;
                if (empId == 1) { // Replace 1 with Ajeesh's actual Employee ID
                    console.log(`EMP ID ${empId} (Ajeesh): Final Total Deductions Breakdown:`);
                    console.log(`- Half Days from Late Arrival: ${summary[empId].halfDaysFromLateArrival} * 0.5 = ${summary[empId].halfDaysFromLateArrival * 0.5}`);
                    console.log(`- Half Days from Missing Morning: ${summary[empId].halfDaysFromMissingMorning} * 0.5 = ${summary[empId].halfDaysFromMissingMorning * 0.5}`);
                    console.log(`- Half Days from Missing Evening: ${Math.floor(summary[empId].missingEveningPunches / 3)} * 0.5 = ${Math.floor(summary[empId].missingEveningPunches / 3) * 0.5}`);
                    console.log(`- Full Day Leaves: ${summary[empId].fullDayLeaves}`);
                    console.log(`Total Deductions: ${summary[empId].totalDeductions}`);
                } else {
                    console.log(`EMP ID ${empId}: Final Total Deductions = ${summary[empId].totalDeductions}, Full Day Leaves = ${summary[empId].fullDayLeaves}`);
                }
            }

            return summary;
        }

        function displayResults(summary) {
            let dateRangeText = '';
            if (dateRange.minDate && dateRange.maxDate) {
                const minDateStr = formatDate(dateRange.minDate);
                const maxDateStr = formatDate(dateRange.maxDate);
                dateRangeText = `${minDateStr} to ${maxDateStr}`;
            }

            let html = `<h3>Attendance Summary ${dateRangeText}</h3>`;
            html += '<table>';
            html += '<tr><th>Employee ID</th><th>Employee Name</th><th class="shift-column">Shift</th><th>Lates</th><th>Half Days (Late Arrival)</th><th>Missing Morning Punches</th><th>Missing Evening Punches</th><th>Early Left</th><th>Full Day Leaves</th><th>Overtime Days</th><th>Total Deductions</th></tr>'; // Changed Early Leaves to Early Left

            for (const empId in summary) {
                const emp = summary[empId];
                let deductionDetails = '';
                if (emp.totalDeductions > 0 || emp.earlyLeftCount > 0) { // Changed from earlyLeaves to earlyLeftCount
                    const reasons = [];
                    if (emp.halfDaysFromLateArrival > 0) {
                        reasons.push(`${emp.halfDaysFromLateArrival} half day${emp.halfDaysFromLateArrival > 1 ? 's' : ''} from late arrival`);
                    }
                    if (emp.halfDaysFromMissingMorning > 0) {
                        reasons.push(`${emp.halfDaysFromMissingMorning} half day${emp.halfDaysFromMissingMorning > 1 ? 's' : ''} from missing morning punches`);
                    }
                    if (emp.halfDaysFromMissingEvening > 0) {
                        reasons.push(`${emp.halfDaysFromMissingEvening} half day${emp.halfDaysFromMissingEvening > 1 ? 's' : ''} from ${emp.missingEveningPunches} missing evening punches`);
                    }
                    if (emp.fullDayLeaves > 0) {
                        reasons.push(`${emp.fullDayLeaves} full day leave${emp.fullDayLeaves > 1 ? 's' : ''}`);
                    }
                    if (emp.earlyLeftCount > 0) { // Changed from earlyLeaves to earlyLeftCount
                        reasons.push(`${emp.earlyLeftCount} early left${emp.earlyLeftCount > 1 ? 's' : ''}`); // Changed to early left
                    }
                    deductionDetails = ` (${reasons.join(', ')})`;
                }
                html += `<tr>
                    <td>${empId}</td>
                    <td>${emp.name}</td>
                    <td class="shift-column">
                        <div class="shift-options">
                            <label><input type="radio" name="shift_${empId}" value="08:00" ${employeeShifts[empId] === '08:00' ? 'checked' : ''} onchange="reprocessAttendance(${empId}, '08:00')"> 08:00 AM</label>
                            <label><input type="radio" name="shift_${empId}" value="09:00" ${employeeShifts[empId] === '09:00' ? 'checked' : ''} onchange="reprocessAttendance(${empId}, '09:00')"> 09:00 AM</label>
                        </div>
                    </td>
                    <td>${emp.lates}</td>
                    <td>${emp.halfDaysFromLateArrival}</td>
                    <td>${emp.missingMorningPunches}</td>
                    <td>${emp.missingEveningPunches}</td>
                    <td>${emp.earlyLeftCount}</td> <!-- Changed from earlyLeaves to earlyLeftCount -->
                    <td>${emp.fullDayLeaves}</td>
                    <td>${emp.overtime}</td>
                    <td>${emp.totalDeductions.toFixed(1)}${deductionDetails}</td>
                </tr>`;
            }

            html += '</table>';

            for (const empId in summary) {
                const emp = summary[empId];
                emp.dailyDetails.sort((a, b) => new Date(a.date) - new Date(b.date));

                html += `<h4>Detailed Attendance for ${emp.name} (Employee ID: ${empId})</h4>`;
                html += '<table>';
                html += '<tr><th>Date</th><th>Day</th><th>Morning Punch-In</th><th>Breakfast Out</th><th>Breakfast In</th><th>Lunch Out</th><th>Lunch In</th><th>Evening Punch-Out</th><th>Late</th><th>Half Day</th><th>Missing Morning Punches</th><th>Missing Evening Punches</th><th>Early Left</th><th>Overtime</th></tr>'; // Changed Early Leave to Early Left

                emp.dailyDetails.forEach(detail => {
                    const isSunday = detail.day === 'Sunday';
                    const isFullDayLeave = detail.morningPunchIn === 'Leave';
                    html += `<tr class="${isSunday ? 'sunday' : ''}">
                        <td>${formatDate(detail.date)}</td>
                        <td>${detail.day}</td>
                        <td class="${isFullDayLeave ? 'leave' : ''}">${detail.morningPunchIn}</td>
                        <td class="${isFullDayLeave ? 'leave' : ''}">${detail.breakfastOut}</td>
                        <td class="${isFullDayLeave ? 'leave' : ''}">${detail.breakfastIn}</td>
                        <td class="${isFullDayLeave ? 'leave' : ''}">${detail.lunchOut}</td>
                        <td class="${isFullDayLeave ? 'leave' : ''}">${detail.lunchIn}</td>
                        <td class="${isFullDayLeave ? 'leave' : detail.eveningPunchOut === 'Missing' ? 'no-out' : detail.earlyLeft !== 'No' ? 'early-left' : ''}">${detail.eveningPunchOut}</td> <!-- Changed earlyLeave to earlyLeft and class to early-left -->
                        <td class="${detail.late !== 'No' ? 'late' : ''}">${detail.late}</td>
                        <td class="${detail.halfDay !== 'No' ? 'leave' : ''}">${detail.halfDay}</td>
                        <td class="${detail.missingMorningCount > 0 ? 'missing-punches' : ''}">${detail.missingMorningCount}</td>
                        <td class="${detail.missingEveningCount > 0 ? 'missing-punches' : ''}">${detail.missingEveningCount}</td>
                        <td>${detail.earlyLeft}</td> <!-- Changed from earlyLeave to earlyLeft -->
                        <td class="${detail.overtime === 'Yes' ? 'overtime' : ''}">${detail.overtime}</td>
                    </tr>`;
                });

                html += '</table>';
            }

            document.getElementById('result').innerHTML = html;
        }

        async function downloadExcel() {
            if (!globalSummary) {
                alert("No data to download!");
                return;
            }

            const workbook = new ExcelJS.Workbook();

            // Summary Sheet
            let dateRangeText = '';
            if (dateRange.minDate && dateRange.maxDate) {
                const minDateStr = formatDate(dateRange.minDate);
                const maxDateStr = formatDate(dateRange.maxDate);
                dateRangeText = `${minDateStr} to ${maxDateStr}`;
            }

            const summarySheet = workbook.addWorksheet('Summary');
            summarySheet.addRow([`Attendance Summary ${dateRangeText}`]);
            summarySheet.addRow(['Employee ID', 'Employee Name', 'Shift', 'Lates', 'Half Days (Late Arrival)', 'Missing Morning Punches', 'Missing Evening Punches', 'Early Left', 'Full Day Leaves', 'Overtime Days', 'Total Deductions']); // Changed Early Leaves to Early Left

            // Style the header row
            summarySheet.getRow(1).font = { bold: true };
            summarySheet.getRow(2).eachCell(cell => {
                cell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'F2F2F2' }
                };
                cell.font = { bold: true };
                cell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                };
            });

            for (const empId in globalSummary) {
                const emp = globalSummary[empId];
                let deductionDetails = '';
                if (emp.totalDeductions > 0 || emp.earlyLeftCount > 0) { // Changed from earlyLeaves to earlyLeftCount
                    const reasons = [];
                    if (emp.halfDaysFromLateArrival > 0) {
                        reasons.push(`${emp.halfDaysFromLateArrival} half day${emp.halfDaysFromLateArrival > 1 ? 's' : ''} from late arrival`);
                    }
                    if (emp.halfDaysFromMissingMorning > 0) {
                        reasons.push(`${emp.halfDaysFromMissingMorning} half day${emp.halfDaysFromMissingMorning > 1 ? 's' : ''} from missing morning punches`);
                    }
                    if (emp.halfDaysFromMissingEvening > 0) {
                        reasons.push(`${emp.halfDaysFromMissingEvening} half day${emp.halfDaysFromMissingEvening > 1 ? 's' : ''} from ${emp.missingEveningPunches} missing evening punches`);
                    }
                    if (emp.fullDayLeaves > 0) {
                        reasons.push(`${emp.fullDayLeaves} full day leave${emp.fullDayLeaves > 1 ? 's' : ''}`);
                    }
                    if (emp.earlyLeftCount > 0) { // Changed from earlyLeaves to earlyLeftCount
                        reasons.push(`${emp.earlyLeftCount} early left${emp.earlyLeftCount > 1 ? 's' : ''}`); // Changed to early left
                    }
                    deductionDetails = ` (${reasons.join(', ')})`;
                }
                const row = summarySheet.addRow([
                    empId,
                    emp.name,
                    employeeShifts[empId] + ' AM', // Include the selected shift
                    emp.lates,
                    emp.halfDaysFromLateArrival,
                    emp.missingMorningPunches,
                    emp.missingEveningPunches,
                    emp.earlyLeftCount, // Changed from earlyLeaves to earlyLeftCount
                    emp.fullDayLeaves,
                    emp.overtime,
                    `${emp.totalDeductions.toFixed(1)}${deductionDetails}`
                ]);
                row.eachCell(cell => {
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });
            }

            // Detailed Sheets for Each Employee
            for (const empId in globalSummary) {
                const emp = globalSummary[empId];
                const detailedSheet = workbook.addWorksheet(`Detailed_${emp.name}_${empId}`);
                detailedSheet.addRow([`Detailed Attendance for ${emp.name} (Employee ID: ${empId})`]);
                detailedSheet.addRow(['Date', 'Day', 'Morning Punch-In', 'Breakfast Out', 'Breakfast In', 'Lunch Out', 'Lunch In', 'Evening Punch-Out', 'Late', 'Half Day', 'Missing Morning Punches', 'Missing Evening Punches', 'Early Left', 'Overtime']); // Changed Early Leave to Early Left

                // Style the header row
                detailedSheet.getRow(1).font = { bold: true };
                detailedSheet.getRow(2).eachCell(cell => {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'F2F2F2' }
                    };
                    cell.font = { bold: true };
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });

                emp.dailyDetails.forEach((detail, index) => {
                    const isSunday = detail.day === 'Sunday';
                    const isFullDayLeave = detail.morningPunchIn === 'Leave';
                    const row = detailedSheet.addRow([
                        formatDate(detail.date),
                        detail.day,
                        detail.morningPunchIn,
                        detail.breakfastOut,
                        detail.breakfastIn,
                        detail.lunchOut,
                        detail.lunchIn,
                        detail.eveningPunchOut,
                        detail.late,
                        detail.halfDay,
                        detail.missingMorningCount,
                        detail.missingEveningCount,
                        detail.earlyLeft, // Changed from earlyLeave to earlyLeft
                        detail.overtime
                    ]);

                    // Apply styles to the row
                    row.eachCell(cell => {
                        cell.border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                        if (isSunday) {
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: 'E6FFE6' }
                            };
                        }
                    });

                    // Apply "Leave" styling to punch-related cells for full-day leaves
                    if (isFullDayLeave) {
                        for (let i = 3; i <= 8; i++) { // Columns 3 to 8 are morningPunchIn to eveningPunchOut
                            row.getCell(i).fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: 'FF0000' }
                            };
                            row.getCell(i).font = { color: { argb: 'FFFFFF' } };
                        }
                    } else {
                        if (detail.eveningPunchOut === 'Missing') {
                            row.getCell(8).fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: 'FFCCCB' }
                            };
                        } else if (detail.earlyLeft !== 'No') { // Changed from earlyLeave to earlyLeft
                            row.getCell(8).fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: 'FFFF00' }
                            };
                        }
                    }
                    if (detail.late !== 'No') {
                        row.getCell(9).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFFF00' }
                        };
                    }
                    if (detail.halfDay !== 'No') {
                        row.getCell(10).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FF0000' }
                        };
                        row.getCell(10).font = { color: { argb: 'FFFFFF' } };
                    }
                    if (detail.missingMorningCount > 0) {
                        row.getCell(11).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'ADD8E6' }
                        };
                    }
                    if (detail.missingEveningCount > 0) {
                        row.getCell(12).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'ADD8E6' }
                        };
                    }
                    if (detail.earlyLeft !== 'No') { // Changed from earlyLeave to earlyLeft
                        row.getCell(13).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFFF00' }
                        };
                    }
                    if (detail.overtime === 'Yes') {
                        row.getCell(14).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: '90EE90' }
                        };
                    }
                });
            }

            // Download the file
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Attendance_Summary.xlsx';
            link.click();
        }

        // Attach the event listener programmatically
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded, attaching event listener");
            const processBtn = document.getElementById('processBtn');
            if (processBtn) {
                processBtn.addEventListener('click', processFile);
                console.log("Event listener attached to processBtn");
            } else {
                console.error("Process button not found!");
            }
        });
    </script>
</body>
</html>
